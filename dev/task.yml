actions:
  create_task:
    params:
      name: ran_k8s_job
      params: # Any task-related params, e.g Pod\Job schema
        manifest:
      idempotency_key: 02662866a380-step-1 # Any string. Just return a task if a one with the same key exists
      timeout: 120 # Sec. Default: 180. Fail task after N sec
      eta: 15 # Sec. Default: 0. Not used atm
      ttl: 580 # Sec. Time after when I can delete task regardless its status, Default: timeout + 5 minutes

      # Logs collecting.
      # Minimal aggregation period: 1s.
      # Consider using logs per second limit of 51000 chars (200 lines * 255 chars) on agent side.
      collect_logs: true # Default: true.
    result: <Task>

  get_task:
    params:
      task_id: 28d4f2f6-a5a3-4d71-9ac2-140c0ca25465
      with_result: true # Default: true
      with_logs: true # Default: false
    result: <Task> # Returns task or null if not exists

  # Do nothing if task.collect_logs == false
  # It means: read fresh logs from Redis each $period and send "task_logs" events during $timeout.
  # Each method call should update $timeout, to stream logs continuously.
  stream_task_logs:
    params:
      task_id: 28d4f2f6-a5a3-4d71-9ac2-140c0ca25465
      since: 1539858796 # Default 0
      duration: 120 # Sec. Default 60. Update duration
      period: 5 # Sec. Default 1

events:
  # Send at least on task.status updating
  task_updated:
    params:
      task_id: 28d4f2f6-a5a3-4d71-9ac2-140c0ca25465

  task_logs:
    params:
      task_id: 28d4f2f6-a5a3-4d71-9ac2-140c0ca25465
      # Minimal aggregation period: 1s.
      # Consider using logs per second limit of 51000 chars (200 lines * 255 chars) on agent side.
      logs:
      - timestamp: 1539858796
        lines: "line1/nline2"
      - timestamp: 1539858795
        lines: "line1"

structures:
  task:
    # Initial attrs:
    name: ran_k8s_job
    idempotency_key: 02662866a380-step-1 # Any string. Just return a task if a one with the same key exists
    timeout: 120 # Sec. Default: 180
    eta: 15 # Sec. Default: 0
    collect_logs: true # Default: true

    # Read-only attrs:
    id: 28d4f2f6-a5a3-4d71-9ac2-140c0ca25465
    created: 1539859630

    # State attrs:
    started: 1539859631
    ended: 1539859641
    status: pending # Task statuses: pending, started, succeed, failed
    logs: # Currently collected logs. Logs should be aggregated for a second at least
    - timestamp: 1539858796
      lines: "line1/nline2"
    - timestamp: 1539858795
      lines: "line1"

    # Result attrs:
    result: "Foo" # Any value or empty. Usually empty string.
    error: # Error should be empty if task succeed
      code: 8356a491-4d28-42f7-841e-02662866a380 # Code to find a point of error throwing
      reason: failed_by_timeout # Error machine name
      message: Some technical explanation # Technical human-readable message